<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Tribut√°rio - Analyst Gest√£o Empresarial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --secondary: #2980b9; --accent: #27ae60; 
            --st-color: #8e44ad; --bg: #f4f6f7; --panel-bg: #ffffff; 
            --pmz-color: #e67e22; --text-main: #333; --border-color: #eee;
        }
        /* MODO ESCURO (DARK MODE) V√ÅRIAVEIS */
        [data-theme="dark"] {
            --primary: #1a252f; --secondary: #3498db; --accent: #2ecc71; 
            --st-color: #9b59b6; --bg: #121212; --panel-bg: #1e1e1e; 
            --text-main: #e0e0e0; --border-color: #333;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); padding: 0; margin: 0; color: var(--text-main); transition: background 0.3s; }
        
        /* Direitos Reservados */
        .top-bar { background-color: var(--primary); color: white; text-align: center; padding: 8px; font-size: 12px; font-weight: bold; letter-spacing: 1px; }

        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        .login-box { background: var(--panel-bg); padding: 40px; border-radius: 10px; box-shadow: 0 15px 30px rgba(0,0,0,0.5); width: 100%; max-width: 350px; text-align: center; color: var(--text-main); transition: all 0.3s; }
        .login-box h2 { margin-top: 0; margin-bottom: 20px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 16px; box-sizing: border-box; background: var(--bg); color: var(--text-main); }
        .btn-login { width: 100%; padding: 12px; background-color: var(--secondary); color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn-login:hover { background-color: #1a5276; }
        .error-msg { color: #e74c3c; font-size: 13px; margin-top: 10px; display: none; font-weight: bold; }
        
        /* Painel Admin Analyst */
        #adminPanel { display: none; background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px dashed var(--secondary); text-align: left;}
        #adminPanel h4 { margin-top: 0; color: var(--secondary); font-size: 14px; text-transform: uppercase;}
        .code-box { background: #2d2d2d; color: #a6e22e; padding: 10px; font-family: monospace; font-size: 11px; border-radius: 4px; margin-top: 10px; word-break: break-all; display: none; border-left: 3px solid var(--accent);}

        #app-content { display: none; padding: 20px; max-width: 1600px; margin: 0 auto; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .btn-action { background-color: var(--secondary); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-action:hover { filter: brightness(0.9); }

        /* Hist√≥rico Recente */
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .history-bar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .history-item { background: var(--panel-bg); border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 15px; font-size: 11px; cursor: pointer; white-space: nowrap; font-weight: bold; color: var(--secondary); }
        .history-item:hover { background: var(--secondary); color: white; }

        .simulator-panel { background: var(--panel-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); margin-bottom: 25px; border-top: 5px solid var(--accent); display: none; animation: slideDown 0.3s ease-out; position: sticky; top: 10px; z-index: 100; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
        .sim-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .sim-header h2 { margin: 0; color: var(--primary); font-size: 18px; text-transform: uppercase; font-weight: 700; }
        .sim-product-name { color: var(--secondary); font-weight: bold; font-size: 14px; margin-left: 10px; }
        
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: #888; border-bottom: 3px solid transparent; margin-right: 5px; transition: 0.2s; }
        .tab-btn:hover { color: var(--secondary); }
        .tab-btn.active { color: var(--secondary); border-bottom: 3px solid var(--secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .sim-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; align-items: end; margin-bottom: 20px; }
        .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-weight: bold; color: var(--text-main); font-size: 15px; box-sizing: border-box; background: var(--bg); }
        #inCustoTabela { border-left: 3px solid #7f8c8d; }
        #inDesconto { border-left: 3px solid #e67e22; color: #d35400; }
        .readonly-input { background-color: rgba(142, 68, 173, 0.1) !important; color: var(--st-color); border: 1px solid rgba(142, 68, 173, 0.3) !important; cursor: default; }
        
        .results-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .scenario-box { padding: 15px; border-radius: 6px; position: relative; display: flex; flex-direction: column; background: var(--bg); border: 1px solid var(--border-color); }
        .scenario-title { font-size: 14px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; }
        .scenario-a .scenario-title { color: var(--accent); }
        .scenario-b .scenario-title { color: var(--st-color); }
        .scenario-inverso .scenario-title { color: var(--pmz-color); }
        .res-line { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .res-destaque { background-color: rgba(128,128,128,0.1); padding: 8px; border-radius: 4px; font-weight: bold; margin-top: 10px; border: 1px solid rgba(128,128,128,0.2); font-size: 15px; }
        .price-tag { font-size: 20px; color: var(--text-main); display: block; text-align: right; }
        .calc-logic { font-family: 'Consolas', monospace; font-size: 10px; color: #888; margin-top: 5px; text-align: right; padding: 4px; border-top: 1px dotted var(--border-color); }
        .calc-logic span { display: block; }
        .profit-section { margin-top: 10px; border-top: 1px dashed var(--border-color); padding-top: 8px; background: rgba(128,128,128,0.05); border-radius: 4px; padding: 8px; }

        .search-box { width: 100%; padding: 15px 15px 15px 45px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; box-sizing: border-box; background: var(--panel-bg); color: var(--text-main); }
        .search-icon { position: absolute; left: 15px; top: 18px; color: #999; font-size: 18px; }
        
        /* Tabela e Pagina√ß√£o */
        .table-container { overflow-x: auto; background: var(--panel-bg); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background-color: var(--primary); color: white; padding: 14px 12px; text-align: left; position: sticky; top: 0; z-index: 10; white-space: nowrap; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: top; }
        tr:hover { background-color: rgba(128,128,128,0.1); cursor: pointer; }
        tr.selected { background-color: rgba(39, 174, 96, 0.1); border-left: 5px solid var(--accent); }
        .cest-badge { background-color: rgba(128,128,128,0.2); color: var(--text-main); padding: 4px 8px; border-radius: 4px; font-weight: bold; font-family: monospace; }
        .ncm-tag { background-color: rgba(52, 152, 219, 0.1); color: var(--secondary); padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 4px; margin-bottom: 4px; display: inline-block; border: 1px solid rgba(52, 152, 219, 0.3); }
        
        .pagination { display: flex; justify-content: center; align-items: center; padding: 15px; gap: 15px; background: var(--panel-bg); border-top: 1px solid var(--border-color); }
        .page-btn { padding: 5px 15px; border: 1px solid var(--secondary); background: transparent; color: var(--secondary); border-radius: 4px; cursor: pointer; font-weight: bold; }
        .page-btn:hover { background: var(--secondary); color: white; }
        .page-btn:disabled { border-color: #ccc; color: #ccc; cursor: not-allowed; background: transparent; }

        /* Toasts */
        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: bold; animation: slideIn 0.3s forwards, fadeOut 0.5s 2.5s forwards; opacity: 0; transform: translateX(100%); }
        .toast.success { border-left: 5px solid var(--accent); }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }

    </style>
</head>
<body>
    <div class="top-bar">Todos os Direitos Reservados a @Analyst Gest√£o Empresarial</div>

    <div id="login-screen">
        <div class="login-box">
            <h2>Acesso Restrito</h2>
            <input type="text" id="user" class="login-input" placeholder="Usu√°rio" oninput="checarAdmin()">
            <input type="password" id="pass" class="login-input" placeholder="Senha" onkeyup="if(event.key === 'Enter') fazerLogin()">
            <button class="btn-login" onclick="fazerLogin()">ENTRAR</button>
            <div id="loginError" class="error-msg">Usu√°rio ou senha incorretos.</div>
            <div style="margin-top: 15px; font-size: 11px; color: #888;">Sistema Protegido SHA-256</div>

            <div id="adminPanel">
                <h4>üõ†Ô∏è Modo Analyst - Novo Usu√°rio</h4>
                <input type="text" id="newUsername" class="login-input" placeholder="Nome do novo usu√°rio" style="padding:8px; margin-bottom:8px;">
                <input type="password" id="newPassword" class="login-input" placeholder="Senha do novo usu√°rio" style="padding:8px; margin-bottom:8px;">
                <button class="btn-action" style="width:100%; background:var(--accent);" onclick="registrarUsuario()">Cadastrar Localmente & Gerar C√≥digo</button>
                <div id="adminResult" class="code-box"></div>
            </div>
        </div>
    </div>

    <div id="app-content">
        <div class="header-controls">
            <h1 style="color: var(--primary); margin: 0;">Cat√°logo Tribut√°rio</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn-action" style="background-color: #34495e;" onclick="toggleDarkMode()">üåô Modo Escuro</button>
                <button class="btn-action" style="background-color: var(--accent);" onclick="exportarCSV()">üì• Exportar CSV</button>
                <button class="btn-action" style="background-color: #e74c3c;" onclick="sairSistema()">üö™ Sair</button>
            </div>
        </div>

        <div class="history-header">
            <div style="font-size: 12px; color: #888; font-weight: bold;">√öLTIMAS SIMULA√á√ïES:</div>
            <button class="btn-action" style="background-color: #8e44ad; font-size: 11px; padding: 5px 10px;" onclick="gerarPDFHistorico()">üìë Baixar Todas em PDF</button>
        </div>
        <div class="history-bar" id="historyBar">
            <span style="color: #ccc; font-size: 11px; font-style: italic;">Nenhuma simula√ß√£o recente.</span>
        </div>

        <div id="simulador" class="simulator-panel">
            <div class="sim-header">
                <div>
                    <h2>Simulador Integrado</h2>
                    <span id="simNomeProduto" class="sim-product-name">...</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn-action" style="background: #e74c3c; font-size: 11px;" onclick="limparSimulacao()">üßπ Limpar Campos</button>
                    <button class="btn-action" onclick="gerarPDFSimulacao()">üìÑ Salvar PDF</button>
                    <button onclick="fecharSimulador()" style="border:none; background:none; cursor:pointer; font-size:24px; color:#999;">&times;</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="mudarAba(event, 'tab-formacao')">Forma√ß√£o de Pre√ßo</button>
                <button class="tab-btn" onclick="mudarAba(event, 'tab-inverso')">C√°lculo Inverso (Extrair ST)</button>
            </div>

            <div id="tab-formacao" class="tab-content active">
                <div class="sim-grid">
                    <div class="input-group"><label>1. Pre√ßo Tabela (R$)</label><input type="text" id="inCustoTabela" placeholder="0,00" onkeyup="calcular()"></div>
                    <div class="input-group"><label style="color: #d35400;">Negocia√ß√£o (%)</label><input type="number" id="inDesconto" placeholder="0" onkeyup="calcular()" step="0.5"></div>
                    <div class="input-group"><label>MVA/IVA (%)</label><input type="text" id="inMva" class="readonly-input" readonly></div>
                    <div class="input-group"><label>Cr√©dito Entrada (%)</label><input type="number" id="inCredito" onkeyup="calcular()" step="0.01"></div>
                    <div class="input-group"><label>Margem Alvo (%)</label><input type="number" id="inMargem" value="40" onkeyup="calcular()"></div>
                </div>
                <div class="results-container">
                    <div class="scenario-box scenario-a">
                        <div class="scenario-title">Cen√°rio 1: Regime Normal</div>
                        <div class="res-line"><span>Custo Nota (c/ Desc):</span> <strong id="resANota">R$ 0,00</strong></div>
                        <div class="res-line"><span style="color:var(--accent)">(-) Cr√©dito Entrada:</span> <span id="resACredito">R$ 0,00</span></div>
                        <div class="res-line" style="border-bottom:1px dashed var(--border-color); padding-bottom:5px;"><span>= Custo L√≠quido:</span> <strong id="resACustoLiq">R$ 0,00</strong></div>
                        <div class="res-line" style="margin-top:10px;"><span>Al√≠quota ICMS Sa√≠da:</span> <strong id="resAIcmsRate">0%</strong></div>
                        <div class="res-line"><span>PIS/COFINS (Sa√≠da):</span> <strong id="resAPisRate">0%</strong></div>
                        <div class="res-line"><span>(-) Impostos na Venda:</span> <span id="resADebitoTotal" style="color:#e74c3c">R$ 0,00</span></div>
                        <div class="res-destaque"><span>Pre√ßo Sugerido:</span><span id="resAPreco" class="price-tag">R$ 0,00</span></div>
                        <div class="profit-section">
                            <div class="res-line"><span>PMZ (Margem Zero):</span> <strong id="resAPMZ" style="color:var(--pmz-color)">R$ 0,00</strong></div>
                            <div class="res-line"><span>Lucro L√≠quido (R$):</span> <strong id="resALucroR" style="color:var(--accent)">R$ 0,00</strong></div>
                            <div class="res-line"><span>Lucro L√≠quido (%):</span> <strong id="resALucroP" style="color:var(--accent)">0%</strong></div>
                        </div>
                        <div class="calc-logic" id="logicA"></div>
                    </div>
                    <div class="scenario-box scenario-b">
                        <div class="scenario-title">Cen√°rio 2: Com ST</div>
                        <div class="res-line"><span>Custo Nota (Produto):</span> <strong id="resBNota">R$ 0,00</strong></div>
                        <div class="res-line"><span>Base de C√°lculo ST:</span> <span id="resBBaseST">R$ 0,00</span></div>
                        <div class="res-line" style="color:var(--st-color)"><strong>(+) ST a Pagar na NF:</strong> <strong id="resBValorST">R$ 0,00</strong></div>
                        <div class="res-line" style="border-bottom:1px dashed var(--border-color); padding-bottom:5px;"><span>= Custo Total:</span> <strong id="resBCustoTotal">R$ 0,00</strong></div>
                        <div class="res-line" style="margin-top:10px;"><span>ICMS Sa√≠da:</span> <strong style="color:#888;">0% (Retido)</strong></div>
                        <div class="res-line"><span>PIS/COFINS (Sa√≠da):</span> <strong id="resBPisRate">0%</strong></div>
                        <div class="res-destaque"><span>Pre√ßo Sugerido (ST):</span><span id="resBPreco" class="price-tag">R$ 0,00</span></div>
                        <div class="profit-section">
                            <div class="res-line"><span>PMZ (Margem Zero):</span> <strong id="resBPMZ" style="color:var(--pmz-color)">R$ 0,00</strong></div>
                            <div class="res-line"><span>Lucro L√≠quido (R$):</span> <strong id="resBLucroR" style="color:var(--accent)">R$ 0,00</strong></div>
                            <div class="res-line"><span>Lucro L√≠quido (%):</span> <strong id="resBLucroP" style="color:var(--accent)">0%</strong></div>
                        </div>
                        <div class="calc-logic" id="logicB"></div>
                    </div>
                </div>
            </div>

            <div id="tab-inverso" class="tab-content">
                <div class="sim-grid">
                    <div class="input-group"><label style="color: var(--pmz-color);">Custo Bruto (COM ST) R$</label><input type="text" id="inInvCustoCheio" style="border-left: 3px solid var(--pmz-color);" onkeyup="calcularInverso()"></div>
                    <div class="input-group"><label>MVA/IVA (%)</label><input type="text" id="inInvMva" class="readonly-input" readonly></div>
                    <div class="input-group"><label>ICMS Sa√≠da (Intra) %</label><input type="text" id="inInvIcmsSaida" class="readonly-input" readonly></div>
                    <div class="input-group"><label>ICMS Entrada (Inter) %</label><input type="number" id="inInvIcmsEntrada" onkeyup="calcularInverso()" step="0.01"></div>
                </div>
                <div class="results-container" style="grid-template-columns: 1fr;">
                    <div class="scenario-box scenario-inverso">
                        <div class="scenario-title">Resultado da Extra√ß√£o de ST</div>
                        <div style="display:flex; justify-content:space-around; align-items:center; flex-wrap:wrap; padding: 10px 0;">
                            <div style="text-align:center;"><span style="display:block; font-size:12px; color:#888;">Custo Original (SEM ST)</span><strong id="resInvBase" style="font-size:24px; color:var(--accent);">R$ 0,00</strong></div>
                            <div style="font-size: 24px; color: #ccc;">+</div>
                            <div style="text-align:center;"><span style="display:block; font-size:12px; color:#888;">Valor da ST Embutida</span><strong id="resInvST" style="font-size:24px; color:var(--st-color);">R$ 0,00</strong></div>
                        </div>
                        <div class="calc-logic" id="logicInv" style="text-align:center; margin-top:10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="position: relative; margin-bottom: 20px;">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" class="search-box" onkeyup="filtrarDebounce()" placeholder="Digite NCM, CEST, Descri√ß√£o ou Item...">
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr><th width="5%">Item</th><th width="10%">CEST</th><th width="20%">NCMs</th><th width="30%">Descri√ß√£o</th><th width="8%">Sa√≠da</th><th width="8%">MVA</th><th width="19%">Regras</th></tr>
                </thead>
                <tbody id="tabelaBody"></tbody>
            </table>
            <div class="pagination">
                <button class="page-btn" id="btnPrev" onclick="mudarPagina(-1)">Anterior</button>
                <span id="pageInfo" style="font-size: 13px; font-weight: bold; color: #888;">P√°gina 1 de 1</span>
                <button class="page-btn" id="btnNext" onclick="mudarPagina(1)">Pr√≥xima</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

<script>
// =================================================================================
// 1. DADOS E CREDENCIAIS
// =================================================================================
let CREDENCIAIS = {
    "alessandro": "2bd195d5b3ae20af56e1ca979130bcfa7ec1662a2c7224c1ebb25f88c2d6bb4f",
	"henrique": "2bd195d5b3ae20af56e1ca979130bcfa7ec1662a2c7224c1ebb25f88c2d6bb4f",
    "rodolfo": "f10c815242d5323aa6230f78ddc4c2206789999175fa39195ffb47bb7bece612",
    "cintra": "a3dfa8378692399f45823a1b1517f170dc45e07a40150b30ffe86278ab579073",
    "lucassup": "f7f85e1e4c7820f2d715c128736a9debd54ca28f796e825672b04a94f94c37b0",
    "cury": "da4af1cade60395837fad2124dcde8084ecbb65571f73cfaf1a37bb9b51cffd4"
};

const csvDados = `ITEM;CEST;NCM/SH;DESCRI√á√ÉO;ICMS SAIDA VAREJO;MVA(IVA);PIS_COFINS;REDU√á√ÉO FORNECEDOR ;LEGISLA√á√ÉO
1;20.001.00;1211.90.90;Henna (embalagens de conte√∫do inferior ou igual a 200 g);18%;57,51%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
2;20.002.00;2712.10.00;Vaselina;18%;110,04%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
3;20.003.00;2814.20.00;Amon√≠aco em solu√ß√£o aquosa (am√¥nia);18%;115,15%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
4;20.004.00;2847.00.00;Per√≥xido de hidrog√™nio, em embalagens de conte√∫do inferior ou igual a 500 ml;18%;57,94%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
5;20.005.00;3006.70.00;Lubrifica√ß√£o √≠ntima;18%;66,17%;M;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
6;20.006.00;3301;"√ìleos essenciais (desterpenados ou n√£o), inclu√≠dos os chamados ‚Äúconcretos‚Äù ou ‚Äúabsolutos‚Äù; resinoides; oleorresinas de extra√ß√£o; solu√ß√µes concentradas de √≥leos essenciais em gorduras, em √≥leos fixos, em ceras ou em mat√©rias an√°logas, obtidas por tratamento de flores atrav√©s de subst√¢ncias gordas ou por macera√ß√£o; subprodutos terp√™nicos residuais da desterpena√ß√£o dos √≥leos essenciais; √°guas destiladas arom√°ticas e solu√ß√µes aquosas de √≥leos essenciais, em embalagens de conte√∫do inferior ou igual a 500 ml";18%;61,91%;M;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
7;20.007.00;3303.00.10;Perfumes (extratos);25%;70,72%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
8;20.008.00;3303.00.20;√Åguas-de-col√¥nia;25%;86,22%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
9;20.009.00;3304.10.00;Produtos de maquilagem para os l√°bios;25%;75,15%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
10;20.010.00;3304.20.10;Sombra, delineador, l√°pis para sobrancelhas e r√≠mel;25%;76,22%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
11;20.011.00;3304.20.90;Outros produtos de maquilagem para os olhos;25%;83,28%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
12;20.012.00;3304.30.00;Prepara√ß√µes para manicuros e pedicuros, incluindo removedores de esmalte √† base de acetona;25%;62,43%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
13;20.013.00;3304.91.00;P√≥s, inclu√≠dos os compactos;25%;55,77%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
14;20.014.00;3304.99.10;Cremes de beleza, cremes nutritivos e lo√ß√µes t√¥nicas;25%;66,63%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
15;20.015.00;3304.99.90;Outros produtos de beleza ou de maquilagem preparados e prepara√ß√µes para conserva√ß√£o ou cuidados da pele, exceto as prepara√ß√µes solares e antissolares;25%;70,30%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
16;20.016.00;3304.99.90;Prepara√ß√µes solares e antissolares;18%;42,40%;M;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
17;20.017.00;3305.10.00;Xampus para o cabelo;18%;42,66%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
18;20.018.00;3305.20.00;Prepara√ß√µes para ondula√ß√£o ou alisamento, permanentes, dos cabelos;18%;62,08%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
19;20.019.00;3305.30.00;Laqu√™s para o cabelo;25%;58,03%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
20;20.020.00;3305.90.00;Outras prepara√ß√µes capilares, incluindo m√°scaras e Finallizadores;25%;70,24%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
21;20.021.00;3305.90.00;Condicionadores;25%;59,30%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
22;20.022.00;3305.90.00;Tintura para o cabelo;25%;45,04%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
23;20.023.00;3306.10.00;Dentifr√≠cios;12%;36,90%;Z;A al√≠quota interna de 12%, est√° prevista no artigo 54, inciso XVIII, do RICMS/SP.;
24;20.024.00;3306.20.00;Fios utilizados para limpar os espa√ßos interdentais (fios dentais);18%;73,44%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
25;20.025.00;3306.90.00;Outras prepara√ß√µes para higiene bucal ou dent√°ria;18%;41,10%;M;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
26;20.026.00;3307.10.00;Prepara√ß√µes para barbear (antes, durante ou ap√≥s);25%;64,80%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
27;20.027.00;3307.20.10;Desodorantes (desodorizantes) corporais l√≠quidos, exceto os classificados no CEST 20.027.01;18%;45,17%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
28;20.027.01;3307.20.10;Lo√ß√µes e √≥leos desodorantes hidratantes l√≠quidos;18%;41,72%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
29;20.028.00;3307.20.10;Antiperspirantes l√≠quidos;18%;37,30%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
30;20.029.00;3307.20.90;Outros desodorantes (desodorizantes) corporais, exceto os classificados no CEST 20.029.01;18%;59,72%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
31;20.029.01;3307.20.90;Outras lo√ß√µes e √≥leos desodorantes hidratantes;18%;43,34%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
32;20.030.00;3307.20.90;Outros antiperspirantes;18%;56,76%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
33;20.031.00;3307.30.00;Sais perfumados e outras prepara√ß√µes para banhos;25%;74,35%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
34;20.032.00;3307.90.00;Outros produtos de perfumaria preparados;25%;50,62%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
35;20.032.01;3307.90.00;Outros produtos de toucador preparados;25%;60,93%;M;REDU√á√ÉO FORNECEDOR 25% (-) 52% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
36;20.033.00;3307.90.00;Solu√ß√µes para lentes de contato ou para olhos artificiais;18%;65,93%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
37;20.034.00;3401.11.90;Sab√µes de toucador em barras, peda√ßos ou figuras moldados, exceto CEST 20.034.01;18%;37,19%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
38;20.034.01;3401.11.90;Len√ßos umedecidos;18%;53,00%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
39;20.035.00;3401.19.00;Outros sab√µes, produtos e prepara√ß√µes, em barras, peda√ßos ou figuras moldados;18%;64,83%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
40;20.036.00;3401.20.10;Sab√µes de toucador sob outras formas;18%;51,55%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
41;20.037.00;3401.30.00;Produtos e prepara√ß√µes org√¢nicos tensoativos para lavagem da pele, na forma de l√≠quido ou de creme, acondicionados para venda a retalho, mesmo contendo sab√£o;18%;46,08%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
42;20.038.00;4014.90.10;Bolsa para gelo ou para √°gua quente;18%;71,91%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
43;20.039.00;4014.90.90;Chupetas e bicos para mamadeiras e para chupetas, de borracha;18%;94,55%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
44;20.040.00;3924.90.00;Chupetas e bicos para mamadeiras e para chupetas, de silicone;18%;69,01%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
44;20.040.00;3926.90.40;Chupetas e bicos para mamadeiras e para chupetas, de silicone;18%;69,01%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
44;20.040.00;926.90.90;Chupetas e bicos para mamadeiras e para chupetas, de silicone;18%;69,01%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
45;20.041.00;4202.1;Malas e maletas de toucador;18%;84,22%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
46;20.042.00;4818.10.00;Papel higi√™nico - folha simples;18%;53,60%;Z;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
47;20.043.00;4818.10.00;Papel higi√™nico - folha dupla, tripla e qu√°drupla;18%;51,57%;Z;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
47;20.043.00;4818.10.00;Papel higi√™nico - folha dupla e tripla;18%;51,57%;Z;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
48;20.044.00;4818.20.00;Len√ßos (inclu√≠dos os de maquilagem) e toalhas de m√£o;18%;85,77%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
49;20.045.00;4818.20.00;Papel toalha de uso institucional do tipo comercializado em rolos igual ou superior a 80 metros e do tipo comercializado em folhas intercaladas;18%;65,18%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
50;20.046.00;4818.30.00;Toalhas e guardanapos de mesa;18%;76,81%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
51;20.047.00;4818.90.90;Toalhas de cozinha (papel toalha de uso dom√©stico);18%;70,72%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
52;20.048.00;9619.00.00;Fraldas, exceto os descritos no CEST 20.048.01;18%;40,77%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
53;20.048.01;9619.00.00;Fraldas de fibras t√™xteis;18%;70,88%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
54;20.049.00;9619.00.00;Tamp√µes higi√™nicos;18%;48,08%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
55;20.050.00;9619.00.00;Absorventes higi√™nicos externos;18%;48,08%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
56;20.051.00;5601.21.90;Hastes flex√≠veis (uso n√£o medicinal);18%;64,01%;M;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
57;20.052.00;5603.92.90;Suti√£ descart√°vel, assemelhados e papel para depila√ß√£o;18%;126,90%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
58;20.053.00;8203.20.90;Pin√ßas para sobrancelhas;18%;72,88%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
59;20.054.00;8214.10.00;Esp√°tulas (artigos de cutelaria);18%;72,88%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
60;20.055.00;8214.20.00;Utens√≠lios e sortidos de utens√≠lios de manicuros ou de pedicuros (inclu√≠das as limas para unhas);18%;90,78%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
61;20.056.00;9025.11.10;Term√¥metros, inclusive o digital;18%;75,41%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
61;20.056.00;9025.19.90;Term√¥metros, inclusive o digital;18%;75,41%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
62;20.057.00;9603.2;Escovas e pinc√©is de barba, escovas para cabelos, para c√≠lios ou para unhas e outras escovas de toucador de pessoas, inclu√≠das as que sejam partes de aparelhos, exceto escovas de dentes;18%;68,94%;T;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
63;20.058.00;9603.21.00;Escovas de dentes, inclu√≠das as escovas para dentaduras;12%;51,99%;Z;REDU√á√ÉO FORNECEDOR 18% (-) 33,33% Final 12% de Credito;artigo 34 do Anexo II do RICMS/SP
64;20.059.00;9603.30.00;Pinc√©is para aplica√ß√£o de produtos cosm√©ticos;18%;60,49%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
65;20.060.00;9605.00.00;Sortidos de viagem, para toucador de pessoas para costura ou para limpeza de cal√ßado ou de roupas;18%;108,51%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
66;20.061.00;9615;"Pentes, travessas para cabelo e artigos semelhantes; grampos (alfinetes) para cabelo; pin√ßas (pinceguiches), onduladores, bobes (rolos) e artefatos semelhantes para penteados, e suas partes, exceto os classificados na posi√ß√£o 8516 e suas partes";18%;69,35%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
67;20.062.00;9616.20.00;Borlas ou esponjas para p√≥s ou para aplica√ß√£o de outros cosm√©ticos ou de produtos de toucador;18%;78,86%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
68;20.063.00;3923.30.90;Mamadeiras;18%;83,30%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
68;20.063.00;3924.10.00;Mamadeiras;18%;83,30%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
68;20.063.00;3924.90.00;Mamadeiras;18%;83,30%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
68;20.063.00;4014.90.90;Mamadeiras;18%;83,30%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
68;20.063.00;7013;Mamadeiras;18%;83,30%;T;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
69;20.064.00;8212.10.20;Aparelhos e l√¢minas de barbear;18%;43,91%;M;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.
69;20.064.00;8212.20.10;Aparelhos e l√¢minas de barbear;18%;43,91%;M;SEM REDU√á√ÉO FORNECEDOR;artigo 52, inciso I, do RICMS/SP.`;

// Carregar Usu√°rios Salvos no Navegador
function carregarUsuariosExtras() {
    try {
        const extra = localStorage.getItem('customUsers');
        if(extra) {
            const parsed = JSON.parse(extra);
            CREDENCIAIS = { ...CREDENCIAIS, ...parsed };
        }
    } catch(e) {}
}

// ---------------------------------------------------------
// STARTUP (Verifica Sess√£o)
// ---------------------------------------------------------
window.onload = function() {
    carregarUsuariosExtras();
    if(sessionStorage.getItem('auth_token')) {
        entrarNoSistema();
    }
};

// =================================================================================
// 2. SEGURAN√áA E LOGIN
// =================================================================================
async function hashSenha(senha) {
    const encoder = new TextEncoder();
    const data = encoder.encode(senha);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function fazerLogin() {
    const userInput = document.getElementById('user').value.toLowerCase().trim();
    const passInput = document.getElementById('pass').value.trim(); 
    const errorMsg = document.getElementById('loginError');

    if (!CREDENCIAIS[userInput]) { errorMsg.style.display = 'block'; return; }

    try {
        const hashGerado = await hashSenha(passInput);
        if (hashGerado === CREDENCIAIS[userInput]) {
            sessionStorage.setItem('auth_token', hashGerado); 
            entrarNoSistema();
        } else {
            errorMsg.innerText = "Usu√°rio ou senha incorretos.";
            errorMsg.style.display = 'block';
        }
    } catch (e) {
        errorMsg.innerText = "Erro no sistema de criptografia.";
        errorMsg.style.display = 'block';
    }
}

function entrarNoSistema() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-content').style.display = 'block';
    inicializar(); 
    renderizarHistorico();
}

function sairSistema() {
    sessionStorage.removeItem('auth_token');
    document.getElementById('app-content').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('user').value = '';
    document.getElementById('pass').value = '';
}

// =================================================================================
// 3. MODO ANALYST (CADASTRO)
// =================================================================================
function checarAdmin() {
    const val = document.getElementById('user').value.toLowerCase().trim();
    document.getElementById('adminPanel').style.display = (val === 'analyst') ? 'block' : 'none';
}

async function registrarUsuario() {
    const user = document.getElementById('newUsername').value.toLowerCase().trim();
    const pass = document.getElementById('newPassword').value.trim();
    if(!user || !pass) return;

    const hash = await hashSenha(pass);
    let extras = {};
    try { extras = JSON.parse(localStorage.getItem('customUsers')) || {}; } catch(e){}
    extras[user] = hash;
    localStorage.setItem('customUsers', JSON.stringify(extras));
    carregarUsuariosExtras(); 

    const resultBox = document.getElementById('adminResult');
    resultBox.style.display = 'block';
    resultBox.innerText = `Pronto! J√° pode logar nesta m√°quina.\n\nPara salvar no HTML Oficial, adicione esta linha na vari√°vel CREDENCIAIS:\n\n"${user}": "${hash}",`;
    
    document.getElementById('newUsername').value = "";
    document.getElementById('newPassword').value = "";
    mostrarToast("Usu√°rio gerado localmente!", "success");
}

// =================================================================================
// 4. ESTRUTURA E TABELA
// =================================================================================
let baseDeDados = [];
let dadosFiltrados = [];
let produtoSelecionado = null;
let timeoutPesquisa;
let paginaAtual = 1;
const itensPorPagina = 50;

function limparTextoInvisivel(t) { return t ? t.replace(/[\u200B-\u200D\uFEFF]/g, '').trim() : ""; }

function mascaraNCM(ncm) {
    let num = ncm.replace(/\D/g, '');
    if(num.length === 8) return num.replace(/^(\d{4})(\d{2})(\d{2})$/, "$1.$2.$3");
    return ncm;
}

function lerLinhaCSV(linha) {
    let colunas = [], txt = '', aspas = false;
    const l = limparTextoInvisivel(linha);
    for (let i = 0; i < l.length; i++) {
        if (l[i] === '"') aspas = !aspas; 
        else if (l[i] === ';' && !aspas) { colunas.push(txt); txt = ''; } 
        else txt += l[i];
    }
    colunas.push(txt);
    return colunas;
}

function inicializar() {
    const linhas = csvDados.split('\n');
    let mapaCest = {};

    for (let i = 1; i < linhas.length; i++) {
        if(!linhas[i].trim()) continue;
        const col = lerLinhaCSV(linhas[i]);
        if (col.length < 5) continue;

        const cest = limparTextoInvisivel(col[1]);
        const ncm = mascaraNCM(limparTextoInvisivel(col[2]));
        
        if (mapaCest[cest]) {
            if (!mapaCest[cest].ncms.includes(ncm)) mapaCest[cest].ncms.push(ncm);
        } else {
            mapaCest[cest] = {
                item: limparTextoInvisivel(col[0]), cest: cest, ncms: [ncm],
                desc: limparTextoInvisivel(col[3]).replace(/^"|"$/g, ''),
                icms: col[4] || "0%", mva: col[5] || "0%",
                pisCofins: col[6] || "T", red: col[7], leg: col[8]
            };
        }
    }
    baseDeDados = Object.values(mapaCest);
    dadosFiltrados = baseDeDados;
    mudarPagina(0);
}

function renderizarTabela() {
    const body = document.getElementById('tabelaBody');
    body.innerHTML = "";
    
    const inicio = (paginaAtual - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const lista = dadosFiltrados.slice(inicio, fim);

    lista.forEach(d => {
        const ncmHtml = d.ncms.map(n => `<span class="ncm-tag">${n}</span>`).join('');
        let descCurta = d.desc.length > 90 ? d.desc.substring(0, 90) + "..." : d.desc;
        let badgePis = (d.pisCofins === 'M') ? '<span style="color:#27ae60; font-size:10px; border:1px solid #27ae60; padding:1px 4px; border-radius:3px;">MONOF√ÅSICO</span>' 
                     : (d.pisCofins === 'Z') ? '<span style="color:#2980b9; font-size:10px; border:1px solid #2980b9; padding:1px 4px; border-radius:3px;">ALIQ. ZERO</span>'
                     : '<span style="color:#c0392b; font-size:10px; border:1px solid #c0392b; padding:1px 4px; border-radius:3px;">TRIBUTADO</span>';

        const tr = document.createElement('tr');
        tr.onclick = () => selecionarProduto(d, tr);
        tr.innerHTML = `<td><strong>${d.item}</strong></td><td><span class="cest-badge">${d.cest}</span></td>
            <td>${ncmHtml}</td><td><div title="${d.desc}">${descCurta}</div><div style="margin-top:4px;">${badgePis}</div></td>
            <td>${d.icms}</td><td>${d.mva}</td><td style="font-size:11px;">${d.red || '-'}</td>`;
        body.appendChild(tr);
    });

    const totalPaginas = Math.ceil(dadosFiltrados.length / itensPorPagina) || 1;
    document.getElementById('pageInfo').innerText = `P√°gina ${paginaAtual} de ${totalPaginas} (${dadosFiltrados.length} itens)`;
    document.getElementById('btnPrev').disabled = paginaAtual === 1;
    document.getElementById('btnNext').disabled = paginaAtual === totalPaginas;
}

function mudarPagina(direcao) {
    const total = Math.ceil(dadosFiltrados.length / itensPorPagina) || 1;
    paginaAtual += direcao;
    if(paginaAtual < 1) paginaAtual = 1;
    if(paginaAtual > total) paginaAtual = total;
    renderizarTabela();
}

function filtrarDebounce() {
    clearTimeout(timeoutPesquisa);
    timeoutPesquisa = setTimeout(filtrar, 300);
}

function filtrar() {
    const t = document.getElementById('searchInput').value.toLowerCase();
    dadosFiltrados = baseDeDados.filter(d => 
        d.cest.includes(t) || d.desc.toLowerCase().includes(t) || d.ncms.some(n => n.includes(t)) || d.item.toString().includes(t)
    );
    paginaAtual = 1;
    renderizarTabela();
}

// =================================================================================
// 5. SIMULADOR E HIST√ìRICO
// =================================================================================
function parsePercent(v) { return parseFloat(v?.replace('%', '').replace(',', '.').trim()) || 0; }
function lerInput(id) { return parseFloat(document.getElementById(id).value?.replace(',', '.')) || 0; }
function formatarMoeda(v) { return isNaN(v) ? "R$ 0,00" : v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

function mudarAba(e, abaId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(abaId).classList.add('active');
    e.target.classList.add('active');
}

function selecionarProduto(dados, elTr) {
    produtoSelecionado = dados;
    document.querySelectorAll('tr.selected').forEach(tr => tr.classList.remove('selected'));
    if(elTr) elTr.classList.add('selected');

    document.getElementById('simulador').style.display = "block";
    document.getElementById('simNomeProduto').innerText = `${dados.item} - ${dados.desc.substring(0, 50)}...`;
    
    document.getElementById('inMva').value = dados.mva;
    let cred = parsePercent(dados.icms);
    if (dados.red && dados.red.includes("Final 12%")) cred = 12; 
    
    document.getElementById('inCredito').value = cred;
    if(!document.getElementById('inCustoTabela').value) document.getElementById('inCustoTabela').value = "100,00"; 
    
    document.getElementById('inInvMva').value = dados.mva;
    document.getElementById('inInvIcmsSaida').value = dados.icms;
    document.getElementById('inInvIcmsEntrada').value = cred;
    if(!document.getElementById('inInvCustoCheio').value) document.getElementById('inInvCustoCheio').value = "150,00";
    
    calcular(); calcularInverso(); salvarHistorico(dados);
}

function limparSimulacao() {
    document.getElementById('inCustoTabela').value = "";
    document.getElementById('inDesconto').value = "";
    document.getElementById('inInvCustoCheio').value = "";
    calcular(); calcularInverso();
}

function fecharSimulador() {
    document.getElementById('simulador').style.display = "none";
    document.querySelectorAll('tr.selected').forEach(tr => tr.classList.remove('selected'));
}

// Hist√≥rico com V√°riaveis da Simula√ß√£o
function getInputsAtuais() {
    return {
        custoTab: lerInput('inCustoTabela'),
        descPct: lerInput('inDesconto'),
        margem: lerInput('inMargem'),
        credIn: lerInput('inCredito'),
        custoCheioInv: lerInput('inInvCustoCheio'),
        iInInv: lerInput('inInvIcmsEntrada')
    };
}

function salvarHistorico(dados) {
    let hist = JSON.parse(localStorage.getItem('histSim') || '[]');
    hist = hist.filter(h => h.cest !== dados.cest); 
    
    hist.unshift({ cest: dados.cest, desc: dados.desc, inputs: getInputsAtuais() });
    if(hist.length > 5) hist.pop();
    localStorage.setItem('histSim', JSON.stringify(hist));
    renderizarHistorico();
}

function atualizarInputsNoHistorico() {
    if(!produtoSelecionado) return;
    let hist = JSON.parse(localStorage.getItem('histSim') || '[]');
    let item = hist.find(h => h.cest === produtoSelecionado.cest);
    if(item) {
        item.inputs = getInputsAtuais();
        localStorage.setItem('histSim', JSON.stringify(hist));
    }
}

function renderizarHistorico() {
    const hist = JSON.parse(localStorage.getItem('histSim') || '[]');
    const bar = document.getElementById('historyBar');
    if(hist.length === 0) return;
    bar.innerHTML = "";
    hist.forEach(h => {
        const btn = document.createElement('div');
        btn.className = 'history-item';
        btn.innerText = `${h.cest} - ${h.desc.substring(0,15)}...`;
        btn.onclick = () => {
            const prod = baseDeDados.find(b => b.cest === h.cest);
            if(prod) selecionarProduto(prod, null);
            document.getElementById('simulador').scrollIntoView({behavior: 'smooth'});
        };
        bar.appendChild(btn);
    });
}

function calcular() {
    if (!produtoSelecionado) return;
    const custoTab = lerInput('inCustoTabela'), descPct = lerInput('inDesconto');
    const margem = lerInput('inMargem'), credIn = lerInput('inCredito');
    const icmsOut = parsePercent(produtoSelecionado.icms), mva = parsePercent(produtoSelecionado.mva);
    const taxaPis = (produtoSelecionado.pisCofins === 'T') ? 9.25 : 0;
    
    const custoNF = custoTab * (1 - (descPct / 100));

    // Cenario A
    const valCred = custoNF * (credIn / 100);
    const custoLiqA = custoNF - valCred;
    let divA = 1 - ((icmsOut + taxaPis + margem) / 100);
    let precoA = divA > 0.001 ? (custoLiqA / divA) : 0;
    const debitoTotA = (precoA * (icmsOut/100)) + (precoA * (taxaPis/100));
    let pmzA = (1 - ((icmsOut+taxaPis)/100)) > 0 ? (custoLiqA / (1 - ((icmsOut+taxaPis)/100))) : 0;
    let lucroRA = precoA - debitoTotA - custoLiqA;

    // Cenario B
    const baseST = custoNF * (1 + (mva / 100));
    let valST = (baseST * (icmsOut / 100)) - (custoNF * (credIn / 100));
    if (valST < 0) valST = 0;
    const custoTotB = custoNF + valST;
    let divB = 1 - ((margem + taxaPis) / 100);
    let precoB = divB > 0.001 ? (custoTotB / divB) : 0;
    let pmzB = (1 - (taxaPis/100)) > 0 ? (custoTotB / (1 - (taxaPis/100))) : 0;
    let lucroRB = precoB - custoTotB - (precoB * (taxaPis / 100));

    document.getElementById('resANota').innerText = formatarMoeda(custoNF);
    document.getElementById('resACredito').innerText = formatarMoeda(valCred);
    document.getElementById('resACustoLiq').innerText = formatarMoeda(custoLiqA);
    document.getElementById('resAIcmsRate').innerText = icmsOut + "%";
    document.getElementById('resAPisRate').innerText = taxaPis + "%";
    document.getElementById('resADebitoTotal').innerText = formatarMoeda(debitoTotA);
    document.getElementById('resAPreco').innerText = formatarMoeda(precoA);
    document.getElementById('resAPMZ').innerText = formatarMoeda(pmzA);
    document.getElementById('resALucroR').innerText = formatarMoeda(lucroRA);
    document.getElementById('resALucroP').innerText = precoA>0 ? ((lucroRA/precoA)*100).toFixed(2)+"%" : "0%";

    const logicA = document.getElementById('logicA');
    if(logicA) logicA.innerHTML = `<span>Custo L√≠q. / (1 - (ICMS + PIS/COFINS + Margem))</span><span>${formatarMoeda(custoLiqA)} / ${divA.toFixed(4)}</span>`;

    document.getElementById('resBNota').innerText = formatarMoeda(custoNF);
    document.getElementById('resBBaseST').innerText = formatarMoeda(baseST);
    document.getElementById('resBValorST').innerText = formatarMoeda(valST);
    document.getElementById('resBCustoTotal').innerText = formatarMoeda(custoTotB);
    document.getElementById('resBPisRate').innerText = taxaPis + "%";
    document.getElementById('resBPreco').innerText = formatarMoeda(precoB);
    document.getElementById('resBPMZ').innerText = formatarMoeda(pmzB);
    document.getElementById('resBLucroR').innerText = formatarMoeda(lucroRB);
    document.getElementById('resBLucroP').innerText = precoB>0 ? ((lucroRB/precoB)*100).toFixed(2)+"%" : "0%";

    const logicB = document.getElementById('logicB');
    if(logicB) logicB.innerHTML = `<span>Custo Total / (1 - (Margem + PIS/COFINS))</span><span>${formatarMoeda(custoTotB)} / ${divB.toFixed(4)}</span>`;

    atualizarInputsNoHistorico();
}

function calcularInverso() {
    if (!produtoSelecionado) return;
    const custoCheio = lerInput('inInvCustoCheio');
    const mva = parsePercent(produtoSelecionado.mva) / 100;
    const iOut = parsePercent(produtoSelecionado.icms) / 100;
    const iIn = lerInput('inInvIcmsEntrada') / 100;

    if(custoCheio <= 0) {
        document.getElementById('resInvBase').innerText = "R$ 0,00"; document.getElementById('resInvST').innerText = "R$ 0,00"; return;
    }
    
    const fatorST = ((1 + mva) * iOut) - iIn;
    let cBase = custoCheio / (1 + fatorST);
    let vST = 0;
    
    if ((cBase * fatorST) < 0) { cBase = custoCheio; vST = 0; } 
    else { vST = custoCheio - cBase; }

    document.getElementById('resInvBase').innerText = formatarMoeda(cBase);
    document.getElementById('resInvST').innerText = formatarMoeda(vST);

    const logicInv = document.getElementById('logicInv');
    if(logicInv) logicInv.innerHTML = `<span>Custo Base = Custo Bruto / { 1 + [ (1 + MVA) * Al√≠q. Sa√≠da - Al√≠q. Entrada ] }</span><span>${formatarMoeda(custoCheio)} / ${(1+fatorST).toFixed(4)}</span>`;

    atualizarInputsNoHistorico();
}

// =================================================================================
// 6. EXPORTA√á√ïES (CSV E PDF AVAN√áADO)
// =================================================================================
function mostrarToast(msg, tipo="success") {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.innerHTML = tipo==='success' ? `‚úÖ ${msg}` : `‚ÑπÔ∏è ${msg}`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function exportarCSV() {
    const blob = new Blob(["\uFEFF" + csvDados], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "base_sistema.csv";
    link.click();
    mostrarToast("CSV exportado com sucesso!", "success");
}

function toggleDarkMode() {
    const root = document.documentElement;
    const isDark = root.getAttribute("data-theme") === "dark";
    root.setAttribute("data-theme", isDark ? "light" : "dark");
}

// FUN√á√ïES DE PDF REFORMULADAS
function gerarPDFSimulacao() {
    if (!produtoSelecionado) return;
    gerarDocumentoPDFBuilder([{ prod: produtoSelecionado, inputs: getInputsAtuais() }], `Simulacao_${produtoSelecionado.cest}`);
}

function gerarPDFHistorico() {
    let hist = JSON.parse(localStorage.getItem('histSim') || '[]');
    if (hist.length === 0) { mostrarToast("Hist√≥rico vazio.", "error"); return; }
    
    let listaExport = [];
    hist.forEach(h => {
        const prodFull = baseDeDados.find(b => b.cest === h.cest);
        if(prodFull) listaExport.push({ prod: prodFull, inputs: h.inputs });
    });
    
    if (listaExport.length > 0) gerarDocumentoPDFBuilder(listaExport, "Historico_Simulacoes");
}

// Construtor do PDF (Refaz todos os calculos para garantir dados fieis no momento da exporta√ß√£o)
function gerarDocumentoPDFBuilder(listaExport, tituloArquivo) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    listaExport.forEach((item, index) => {
        if (index > 0) doc.addPage();

        const prod = item.prod;
        const inp = item.inputs || { custoTab: 100, descPct: 0, margem: 40, credIn: 12, custoCheioInv: 150, iInInv: 12 };
        
        // Refaz Calculo Cenario A e B
        const icmsOut = parsePercent(prod.icms), mva = parsePercent(prod.mva);
        const taxaPis = (prod.pisCofins === 'T') ? 9.25 : 0;
        const custoNF = inp.custoTab * (1 - (inp.descPct / 100));
        
        const valCred = custoNF * (inp.credIn / 100);
        const custoLiqA = custoNF - valCred;
        let divA = 1 - ((icmsOut + taxaPis + inp.margem) / 100);
        let precoA = divA > 0.001 ? (custoLiqA / divA) : 0;
        const debitoTotA = (precoA * (icmsOut/100)) + (precoA * (taxaPis/100));
        let pmzA = (1 - ((icmsOut+taxaPis)/100)) > 0 ? (custoLiqA / (1 - ((icmsOut+taxaPis)/100))) : 0;
        let lucroRA = precoA - debitoTotA - custoLiqA;
        let lucroPA = precoA>0 ? ((lucroRA/precoA)*100) : 0;

        const baseST = custoNF * (1 + (mva / 100));
        let valST = (baseST * (icmsOut / 100)) - (custoNF * (inp.credIn / 100));
        if (valST < 0) valST = 0;
        const custoTotB = custoNF + valST;
        let divB = 1 - ((inp.margem + taxaPis) / 100);
        let precoB = divB > 0.001 ? (custoTotB / divB) : 0;
        let pmzB = (1 - (taxaPis/100)) > 0 ? (custoTotB / (1 - (taxaPis/100))) : 0;
        let lucroRB = precoB - custoTotB - (precoB * (taxaPis / 100));
        let lucroPB = precoB>0 ? ((lucroRB/precoB)*100) : 0;

        // Refaz Calculo Inverso
        const fatorST = ((1 + (mva/100)) * (icmsOut/100)) - (inp.iInInv/100);
        let cBase = inp.custoCheioInv / (1 + fatorST);
        let vST = 0;
        if ((cBase * fatorST) < 0) { cBase = inp.custoCheioInv; vST = 0; } else { vST = inp.custoCheioInv - cBase; }

        // ----- DESENHO DO PDF -----
        // Header
        doc.setFillColor(44, 62, 80);
        doc.rect(0, 0, 210, 20, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14); doc.setFont(undefined, 'bold');
        doc.text("Analyst Gest√£o - Relat√≥rio de Simula√ß√£o", 15, 13);

        // Info Produto
        doc.setTextColor(51, 51, 51); doc.setFontSize(10);
        doc.text(`Item: ${prod.item}`, 15, 30);
        doc.text(`CEST: ${prod.cest}`, 70, 30);
        doc.text(`NCM: ${prod.ncms.join(', ')}`, 130, 30);
        
        doc.setFont(undefined, 'normal');
        const descLines = doc.splitTextToSize(`Descri√ß√£o: ${prod.desc}`, 180);
        doc.text(descLines, 15, 38);
        let y = 38 + (descLines.length * 5) + 5;

        // ABA 1
        doc.setFontSize(12); doc.setFont(undefined, 'bold');
        doc.setTextColor(41, 128, 185);
        doc.text("FORMA√á√ÉO DE PRE√áO (Cen√°rio 1 e 2)", 15, y); y += 6;
        
        doc.setFontSize(9); doc.setTextColor(100, 100, 100);
        doc.text(`Pre√ßo Tabela: R$ ${inp.custoTab.toFixed(2)} | Desconto: ${inp.descPct}% | Margem: ${inp.margem}% | Cr√©d. Ent.: ${inp.credIn}% | MVA: ${prod.mva}`, 15, y); y += 8;

        // Caixa Cen√°rio 1
        doc.setDrawColor(200, 200, 200);
        doc.setFillColor(241, 248, 233);
        doc.rect(15, y, 85, 75, 'FD');
        doc.setFont(undefined, 'bold'); doc.setTextColor(46, 125, 50);
        doc.text("Cen√°rio 1: Regime Normal", 20, y + 8);

        doc.setFont(undefined, 'normal'); doc.setTextColor(51, 51, 51);
        let yA = y + 16;
        doc.text(`Custo Nota: ${formatarMoeda(custoNF)}`, 20, yA); yA += 6;
        doc.text(`(-) Cr√©d. Entrada: ${formatarMoeda(valCred)}`, 20, yA); yA += 6;
        doc.text(`= Custo L√≠quido: ${formatarMoeda(custoLiqA)}`, 20, yA); yA += 6;
        doc.text(`Al√≠q. Sa√≠da: ${prod.icms}`, 20, yA); yA += 6;
        doc.text(`PIS/COFINS: ${taxaPis}%`, 20, yA); yA += 6;
        doc.text(`(-) Impostos: ${formatarMoeda(debitoTotA)}`, 20, yA); yA += 8;
        
        doc.setFont(undefined, 'bold');
        doc.text(`Pre√ßo Sugerido: ${formatarMoeda(precoA)}`, 20, yA); yA += 8;
        doc.text(`PMZ: ${formatarMoeda(pmzA)}`, 20, yA); yA += 6;
        doc.setTextColor(39, 174, 96);
        doc.text(`Lucro L√≠q: ${formatarMoeda(lucroRA)} (${lucroPA.toFixed(2)}%)`, 20, yA);

        // Caixa Cen√°rio 2
        doc.setFillColor(243, 229, 245);
        doc.rect(105, y, 85, 75, 'FD');
        doc.setFont(undefined, 'bold'); doc.setTextColor(142, 68, 173);
        doc.text("Cen√°rio 2: Com ST", 110, y + 8);

        doc.setFont(undefined, 'normal'); doc.setTextColor(51, 51, 51);
        let yB = y + 16;
        doc.text(`Custo Nota: ${formatarMoeda(custoNF)}`, 110, yB); yB += 6;
        doc.text(`Base Calc ST: ${formatarMoeda(baseST)}`, 110, yB); yB += 6;
        doc.text(`(+) ST Pagar: ${formatarMoeda(valST)}`, 110, yB); yB += 6;
        doc.text(`= Custo Total: ${formatarMoeda(custoTotB)}`, 110, yB); yB += 6;
        doc.text(`PIS/COFINS: ${taxaPis}%`, 110, yB); yB += 14;

        doc.setFont(undefined, 'bold');
        doc.text(`Pre√ßo Sugerido (ST): ${formatarMoeda(precoB)}`, 110, yB); yB += 8;
        doc.text(`PMZ: ${formatarMoeda(pmzB)}`, 110, yB); yB += 6;
        doc.setTextColor(39, 174, 96);
        doc.text(`Lucro L√≠q: ${formatarMoeda(lucroRB)} (${lucroPB.toFixed(2)}%)`, 110, yB);

        y += 90;

        // ABA 2
        doc.setFontSize(12); doc.setFont(undefined, 'bold');
        doc.setTextColor(230, 126, 34);
        doc.text("C√ÅLCULO INVERSO (Extra√ß√£o de ST)", 15, y); y += 6;
        
        doc.setFontSize(9); doc.setTextColor(100, 100, 100);
        doc.text(`Custo Bruto (ST): R$ ${inp.custoCheioInv.toFixed(2)} | MVA: ${prod.mva} | ICMS Sa√≠da: ${prod.icms} | ICMS Ent.: ${inp.iInInv}%`, 15, y); y += 8;

        doc.setFillColor(255, 243, 224);
        doc.rect(15, y, 175, 25, 'FD');

        doc.setFontSize(11); doc.setTextColor(51, 51, 51);
        doc.text("Custo Original (Sem ST)", 35, y + 10);
        doc.setFont(undefined, 'bold'); doc.setTextColor(46, 125, 50);
        doc.setFontSize(14); doc.text(formatarMoeda(cBase), 35, y + 18);

        doc.setFontSize(14); doc.setTextColor(200, 200, 200);
        doc.text("+", 100, y + 15);

        doc.setFontSize(11); doc.setTextColor(51, 51, 51);
        doc.text("Valor da ST Embutida", 130, y + 10);
        doc.setFont(undefined, 'bold'); doc.setTextColor(142, 68, 173);
        doc.setFontSize(14); doc.text(formatarMoeda(vST), 130, y + 18);
    });

    doc.save(`${tituloArquivo}.pdf`);
    mostrarToast("PDF gerado com sucesso!", "success");
}

</script>
</body>
</html>
